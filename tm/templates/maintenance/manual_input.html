{% extends 'base.html' %}

{% block title %}Manual Data Input{% endblock %}

{% block content %}
{% load static %}
<div style="border: 10px solid black;">
<h1 style="text-align: center; margin-top: 200px;">Manual Data Input</h1>
<div style="text-align: center;">
  <form method="post" id="manual-input-form" style="display: inline-block; text-align: left;">
    {% csrf_token %}
    <div id="input-rows">
      <!-- Initial row -->
      <div class="input-row">
        {{ form.as_p }}
        <button type="button" onclick="deleteRow(this)">Delete</button>
      </div>
      <hr /> <!-- Horizontal line to separate rows -->
    </div>
    <button type="button" onclick="addRow()">Add Row</button><br>
    <button type="submit">Submit</button>
  </form>
</div>

{% if error_message %}
<div style="color: red; text-align: center;">Error: {{ error_message }}</div>
{% endif %}

{% if data_to_display %}
<hr />
<h1 style="text-align: center;">Your Last Results Were:</h1>

{% if maintenance_status and maintenance_status != "Vehicle condition is good." %}
<hr />
<h1 style="text-align: center;">Outlier Rows</h1>
<div style="text-align: center;">{{ data_to_display|safe }}</div>

{% if column_averages %}
<hr />
<h2 style="text-align: center;">Column Averages</h2>
<ul style="list-style-type: none; padding: 0; text-align: left; display: inline-block;">
  {% for column, average in column_averages.items %}
  <li>{{ column }}: {{ average }}</li> <br>
  {% endfor %}
</ul>
{% endif %}
{% endif %}

<hr />
<h2 style="text-align: center;">Maintenance Status</h2>
<p style="text-align: center;">{{ maintenance_status }}</p>
{% else %}
<h1 style="text-align: center;">You Haven't Entered Data Yet, Please Enter Data so that the results can be displayed here</h1>
{% endif %}
<a href="{% url 'download_test_case_excel' %}" download>Download Test Case Excel</a>
<a href="{% url 'upload_display_excel' %}">Download Test Case Excel</a>
</div>

<script>
  function addRow() {
    const form = document.getElementById('manual-input-form');
    const newRow = document.querySelector('.input-row').cloneNode(true);
    const inputs = newRow.querySelectorAll('input, select');
    inputs.forEach(input => {
      input.value = ''; // Clear the input fields
      const name = input.getAttribute('name');
      if (name) {
        const newName = name.replace(/\d+/, function (match) {
          return parseInt(match) + 1; // Increment the index for new row
        });
        input.setAttribute('name', newName);
      }
    });
    newRow.querySelector('button').textContent = 'Delete';
    newRow.querySelector('button').setAttribute('onclick', 'deleteRow(this)');
    document.getElementById('input-rows').appendChild(newRow);
    document.getElementById('input-rows').appendChild(document.createElement('hr'));
  }

  function deleteRow(button) {
    const row = button.parentElement;
    row.parentNode.removeChild(row);
    // Remove the horizontal line before the deleted row
    const hr = row.nextElementSibling;
    if (hr && hr.tagName === 'HR') {
      hr.parentNode.removeChild(hr);
    }
  }
</script>
{% endblock %}
